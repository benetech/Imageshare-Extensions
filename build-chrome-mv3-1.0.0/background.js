!function(){"use strict";const e={SEARCH:"search-only",WORKING:"working",READY:"reset",NOTIFICATION:"notification",GET_SELECTION:"get-selection",FIND_TERMS:"find-terms",VIEW_TERM:"view-term"},t="content",n="background",o="standard",s="advanced",r={16:"./icons/Imageshare-logo-no-text-white-16x16.jpg",48:"./icons/Imageshare-logo-no-text-white-48x48.jpg",128:"./icons/Imageshare-logo-no-text-white-128x128.jpg",1024:"./icons/Imageshare-logo-no-text-white-1024x1024.jpg"},a="https://imgsdev.wpengine.com/json-api/resources/";var c=chrome;const i=async()=>new Promise((e=>{c.storage.local.get(["settings"],(t=>{if(void 0===t.settings)return e({subject:void 0,type:void 0,accommodation:void 0,source:void 0,setActiveTab:!0,createKeywordLinks:!1});e(t.settings)}))})),d=e=>c.tabs.query({active:!0,currentWindow:!0},(t=>e(t[0]))),h=e=>{new Promise((e=>{i().then((t=>e(!!t.setActiveTab)))})).then((t=>c.tabs.create({url:e,active:t})))},g=e=>fetch(e,{method:"GET",mode:"cors"}).then((e=>e.json())).then((e=>e.data)),m=c.runtime.getURL("icons/Imageshare-logo-no-text.png"),u=(n,o)=>{d((s=>{c.tabs.sendMessage(s.id,{command:e.NOTIFICATION,target:t,title:n,message:o,icon:m})}))},l=()=>{console.debug("Setting up right-click context menu");const e="selection",t="parent selection";c.contextMenus.create({title:"Imageshare Search",contexts:[e],id:t}),c.contextMenus.create({title:"Standard Search",contexts:[e],parentId:t,id:"imageshare-standard-search"}),c.contextMenus.create({title:"Advanced Search",contexts:[e],parentId:t,id:"imageshare-advanced-search"})};var p=c.action;const b=e=>void 0===e||"0"==e?"":encodeURIComponent(e),I=e=>e.length>10?e.substr(0,9)+"â€¦":e,f=e=>{return(t=e,g(`${a}filter/?query=${t}`)).then((t=>{p.setBadgeText({text:t.length.toString()});const n=I(e);return 0===t.length?(console.debug(`No results found for "${n}"`),u(`No results for "${n}"`,"Try another search term.")):1===t.length?(console.debug(`One result found for "${n}"`),h(t[0].permalink),u("One match found","It has been opened in a new tab.")):(console.debug(`${t.length} results found for "${n}"`),h("https://imageshare.benetech.org/?page=search&q="+e),void u(`${t.length} matches for "${n}"`,"They have been opened in a new tab."))})).catch((e=>console.error("Unable to fetch standard search query results from API",e)));var t},v=(e,t,n,o,s)=>{const r=b(t),c=b(n),i=b(o),d=b(s);return e=encodeURIComponent(e),((e,t,n,o,s)=>g(`${a}filter/?query=${e}&subject=${t}&type=${n}&acc=${o}&src=${s}`))(term,r,c,i,d).then((e=>{if(p.setBadgeText({text:e.length.toString()}),shortTerm=I(term),0===e.length)return console.debug(`No results found for "${shortTerm}"`),u(`No results for "${shortTerm}"`,"Try another term or adjust search criteria.");if(1===e.length){console.debug(`One result found for "${shortTerm}"`);const t=e[0].permalink;return h(t),u("One match found","It has been opened in a new tab.")}console.debug(`${e.length} results found for "${shortTerm}"`),h("https://imageshare.benetech.org/?page=search&q="+term+"&subject="+r+"&type="+c+"&acc="+i+"&src="+d),u(`${e.length} matches for "${shortTerm}"`,"They have been opened in a new tab.")})).catch((e=>console.error("Unable to fetch advanced search query results from API",e)))},T=e=>e.type===o?f(e.selection):e.type===s?i().then((t=>{var n;void 0===(n=t).subject&&void 0===n.type&&void 0===n.accommodation&&void 0===n.source?(console.debug("No pre-existing criteria, notifying user."),u("No advanced search criteria set.","Configure these criteria on the options page."),c.runtime.openOptionsPage?c.runtime.openOptionsPage():window.open(c.runtime.getURL("options.html"))):v(e.selection,t.subject,t.type,t.accommodation,t.source)})):void 0,$=()=>{d((n=>{c.tabs.sendMessage(n.id,{command:e.WORKING,target:t})}))},x=()=>{d((n=>{c.tabs.sendMessage(n.id,{command:e.READY,target:t})}))};((e,t)=>{c.runtime.onInstalled.addListener(l),c.contextMenus.onClicked.addListener(e),c.runtime.onMessage.addListener(t),console.debug("Background script loaded.")})(((t,n)=>{const r=t.selectionText,a=t.menuItemId,c={"imageshare-standard-search":o,"imageshare-advanced-search":s};console.debug(`Menu item ${a} clicked with selection "${r}"`),$(),T({command:e.BACKGROUND_SEARCH,type:c[a],selection:r}).then(x)}),((t,o,s)=>{var a;return console.debug("Background receiving message",t),t.target!==n&&s(),t.command===e.VIEW_TERM&&(h((a=t.term,"https://imageshare.benetech.org/?page=search&q="+encodeURIComponent(a))),s()),t.command&&t.command===e.NOTIFICATION&&(u(t.title,t.message),s()),t.command&&t.command===e.SEARCH&&($(),T(t).then(x).then(s)),t.scheme&&"dark"===t.scheme&&(console.debug("Setting dark color scheme icons"),p.setIcon({path:r}),s()),!0}))}();