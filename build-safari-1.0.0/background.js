!function(){"use strict";const e={SEARCH:"search-only",WORKING:"working",READY:"reset",NOTIFICATION:"notification",GET_SELECTION:"get-selection"},t="background",n="standard",o="advanced",a={16:"./icons/Imageshare-logo-no-text-white.png",48:"./icons/Imageshare-logo-no-text-white.png",128:"./icons/Imageshare-logo-no-text-white.png",512:"./icons/Imageshare-logo-no-text-white.png",1024:"./icons/Imageshare-logo-no-text-white.png"},s="https://imgsdev.wpengine.com/json-api/resources/";var r=chrome;const c=e=>fetch(e,{method:"GET"}).then((e=>e.json())).then((e=>e.data)),i=r.runtime.getURL("icons/Imageshare-logo-no-text.png"),d=(t,n)=>{var o;o=o=>{r.tabs.sendMessage(o.id,{command:e.NOTIFICATION,target:"content",title:t,message:n,icon:i})},r.tabs.query({active:!0,currentWindow:!0},(e=>o(e[0])))},g=()=>{console.debug("Setting up right-click context menu");const e="selection",t="parent selection";r.contextMenus.create({title:"Imageshare Search",contexts:[e],id:t}),r.contextMenus.create({title:"Standard Search",contexts:[e],parentId:t,id:"imageshare-standard-search"}),r.contextMenus.create({title:"Advanced Search",contexts:[e],parentId:t,id:"imageshare-advanced-search"})},h=e=>new Promise((e=>{r.storage.local.get(["active"],(t=>e(!!t.active)))})).then((t=>r.tabs.create({url:e,active:t}))),l=e=>{var t;e.type!==n?e.type===o&&new Promise((e=>{r.storage.local.get(["settings"],(t=>e(t.settings)))})).then((t=>{void 0===t?(console.debug("No pre-existing criteria, notifying user."),d("No advanced search criteria set.","Configure advanced search criteria on options page."),r.runtime.openOptionsPage?r.runtime.openOptionsPage():window.open(r.runtime.getURL("options.html"))):((e,t,n,o,a)=>{((e,t,n,o,a)=>c(`${s}filter/?query=${e}&subject=${t}&type=${n}&acc=${o}&src=${a}`))(e,t,n,o,a).then((s=>{if(0===s.length)return console.debug(`No results found for "${e}"`),d(`No results found for ${e}`,"Try another selection or adjust your search criteria.");if(1===s.length){console.debug(`One result found for ${e}`);const t=s[0].permalink;return h(t),d("One match found","It has been opened in a new tab.")}console.debug(`${s.length} found for ${e}`),h("https://imageshare.benetech.org/?page=search&q="+e+"&subject="+t+"&type="+n+"&acc="+o+"&src="+a),d(`${s.length} matches for ${e}`,"These matches have been opened in a new tab.")})).catch((e=>console.error("Unable to fetch advanced search query results from API",e)))})(e.selection,t.subject,t.type,t.accommodation,t.source)})):(e=>c(`${s}filter/?query=${e}`))(t=e.selection).then((e=>0===e.length?(console.debug(`No results found for "${t}"`),d("No results",`"${t}" yielded no Imageshare entries.`)):1===e.length?(console.debug(`One result found for ${t}`),h(e[0].permalink),d("One match found","It has been opened in a new tab.")):(console.debug(`${e.length} found for ${t}`),h("https://imageshare.benetech.org/?page=search&q="+t),void d(`${e.length} matches for ${t}`,"These matches have been opened in a new tab.")))).catch((e=>console.error("Unable to fetch standard search query results from API",e)))};r.runtime.onInstalled.addListener(g),r.contextMenus.onClicked.addListener(((t,a)=>{const s=t.selectionText,r=t.menuItemId,c={"imageshare-standard-search":n,"imageshare-advanced-search":o};console.debug(`Menu item ${r} clicked with selection "${s}"`),l({command:e.BACKGROUND_SEARCH,type:c[r],selection:s})})),r.runtime.onMessage.addListener(((n,o,s)=>{console.debug("Background receiving message",n),n.target!==t&&s(),n.command&&n.command===e.NOTIFICATION&&d(n.title,n.message),n.command&&n.command===e.SEARCH&&l(n),n.scheme&&"dark"===n.scheme&&(console.debug("Setting dark color scheme icons"),r.browserAction.setIcon({path:a})),s()})),console.debug("Background script loaded.")}();